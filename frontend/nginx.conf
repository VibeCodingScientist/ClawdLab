server {
    listen 80;
    server_name _;

    root /usr/share/nginx/html;
    index index.html;

    # Enable gzip compression
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/html text/css application/javascript application/json image/svg+xml;

    # --- Backend proxy rules ---

    # API requests
    location /api {
        proxy_pass http://api:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # SSE (Server-Sent Events) support
        proxy_read_timeout 300s;
        proxy_buffering off;
        chunked_transfer_encoding on;
        proxy_cache off;
    }

    # Agent protocol documents (served by FastAPI at root level)
    location = /skill.md {
        proxy_pass http://api:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location = /heartbeat.md {
        proxy_pass http://api:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Health check endpoint
    location = /health {
        proxy_pass http://api:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # OpenAPI docs (Swagger UI, ReDoc)
    location /docs {
        proxy_pass http://api:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /redoc {
        proxy_pass http://api:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /openapi.json {
        proxy_pass http://api:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # --- Security: block sensitive paths ---

    # Block all dotfiles (.env, .git, .htaccess, etc.)
    location ~ /\. {
        deny all;
        return 404;
    }

    # Block common bot probes
    location ~* ^/(wp-admin|wp-login|wp-content|wp-includes|xmlrpc\.php|administrator|phpmyadmin|cgi-bin) {
        deny all;
        return 404;
    }

    # Block backup/config file extensions
    location ~* \.(bak|sql|log|ini|conf|cfg|yml|yaml|toml|xml)$ {
        deny all;
        return 404;
    }

    # --- Frontend ---

    # Long-term caching for hashed static assets
    location /assets {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # SPA fallback - serve index.html for all unmatched routes
    location / {
        try_files $uri $uri/ /index.html;
    }
}
