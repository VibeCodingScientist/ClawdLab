Bootstrap: docker
From: ubuntu:22.04

%labels
    Author Autonomous Scientific Research Platform
    Version 1.0
    Description Mathematics Verification Engine with Lean 4, Mathlib, Z3, and CVC5

%post
    # Update and install base dependencies
    apt-get update && apt-get install -y \
        curl \
        git \
        wget \
        build-essential \
        cmake \
        python3 \
        python3-pip \
        libgmp-dev \
        libssl-dev \
        pkg-config \
        && rm -rf /var/lib/apt/lists/*

    # Install elan (Lean version manager)
    curl https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh -sSf | \
        bash -s -- -y --default-toolchain leanprover/lean4:v4.3.0

    # Add elan to path
    export PATH="/root/.elan/bin:$PATH"

    # Verify Lean installation
    lean --version
    lake --version

    # Clone and build Mathlib4
    mkdir -p /opt/mathlib4
    cd /opt/mathlib4
    git clone --depth 1 https://github.com/leanprover-community/mathlib4.git .
    lake build

    # Build Mathlib cache for faster builds
    lake exe cache get

    # Install Z3
    cd /tmp
    wget https://github.com/Z3Prover/z3/releases/download/z3-4.12.4/z3-4.12.4-x64-glibc-2.35.zip
    unzip z3-4.12.4-x64-glibc-2.35.zip
    cp z3-4.12.4-x64-glibc-2.35/bin/z3 /usr/local/bin/
    chmod +x /usr/local/bin/z3
    rm -rf z3-*

    # Install CVC5
    wget https://github.com/cvc5/cvc5/releases/download/cvc5-1.0.8/cvc5-Linux
    mv cvc5-Linux /usr/local/bin/cvc5
    chmod +x /usr/local/bin/cvc5

    # Verify installations
    z3 --version
    cvc5 --version

    # Install Python dependencies for integration
    pip3 install --no-cache-dir \
        pexpect \
        aiofiles

    # Create workspace directory
    mkdir -p /workspace
    chmod 777 /workspace

    # Clean up
    apt-get clean
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

%environment
    export PATH="/root/.elan/bin:$PATH"
    export MATHLIB_PATH="/opt/mathlib4"
    export LEAN_PATH="/opt/mathlib4/build/lib"

%runscript
    exec "$@"

%test
    # Test Lean
    echo "Testing Lean 4..."
    lean --version

    # Test Z3
    echo "Testing Z3..."
    z3 --version

    # Test CVC5
    echo "Testing CVC5..."
    cvc5 --version

    # Test a simple Lean proof
    echo "Testing simple Lean proof..."
    cat > /tmp/test.lean << 'EOF'
theorem test_add_comm (n m : Nat) : n + m = m + n := Nat.add_comm n m
#check test_add_comm
EOF
    lean /tmp/test.lean && echo "Lean proof test passed!"

    echo "All tests passed!"

%help
    Mathematics Verification Container

    This container provides:
    - Lean 4 with Mathlib for formal theorem proving
    - Z3 SMT solver for automated reasoning
    - CVC5 SMT solver for automated reasoning

    Usage:
        singularity exec math-verifier.sif lean <file.lean>
        singularity exec math-verifier.sif z3 <file.smt2>
        singularity exec math-verifier.sif cvc5 <file.smt2>
        singularity exec math-verifier.sif lake build

    Environment variables:
        MATHLIB_PATH: Path to Mathlib installation
        LEAN_PATH: Lean library path
